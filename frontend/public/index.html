<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Anonymous Salary Reveal â€” Zama FHEVM</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&display=swap" rel="stylesheet">
  <style>
    /* ===== Greenline Dollar UI (square, green, $-themed background; IDs preserved for JS) ===== */
    :root{
      --bg:#07100b;             /* canvas */
      --ink:#e6f6ea;            /* text */
      --muted:#a2c7a7;          /* secondary */
      --line:#16341f;           /* borders */
      --panel:#0a160e;          /* cards */
      --brand:#22c55e;          /* green */
      --brand-deep:#166534;     /* deep green */
      --accent:#10b981;         /* mint */
      --warn:#f59e0b;           /* amber */
      --shadow:0 10px 28px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--ink);
      font:15px/1.6 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
      background:radial-gradient(1200px 700px at 10% -10%, #0e2c1a 0%, var(--bg) 60%) fixed;
    }

    /* Dollar pattern + grid overlay */
    body::before{
      content:"";position:fixed;inset:0;z-index:-2;opacity:.14;pointer-events:none;
      background:
        repeating-linear-gradient(0deg, transparent 0 29px, rgba(16,185,129,.06) 29px 30px),
        repeating-linear-gradient(90deg, transparent 0 29px, rgba(16,185,129,.06) 29px 30px),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'><rect width='160' height='160' fill='none'/><text x='14' y='88' font-family='ui-monospace,Menlo,Consolas,monospace' font-size='64' fill='%2322c55e' fill-opacity='0.14'>$</text><text x='90' y='150' font-family='ui-monospace,Menlo,Consolas,monospace' font-size='64' fill='%23166534' fill-opacity='0.12'>$</text></svg>");
      background-size:auto, auto, 200px 200px;
    }
    body::after{
      content:"";position:fixed;inset:-15%;z-index:-1;pointer-events:none;
      background:radial-gradient(600px 420px at 85% 20%, rgba(16,185,129,.18), transparent 70%),
                 radial-gradient(800px 620px at 20% 80%, rgba(34,197,94,.18), transparent 70%);
      filter:blur(40px);
    }

    .wrap{max-width:1160px;margin:0 auto;padding:28px}

    /* Header */
    header.hero{display:flex;flex-direction:column;align-items:stretch;gap:14px;margin-bottom:22px}
    .logo{display:none}
    .logo b{color:var(--brand)}
    .badge{border:1px solid var(--line);color:var(--muted);padding:7px 12px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));backdrop-filter:blur(6px)}
    .spacer{flex:1}

    /* Buttons â€” square, green */
    .btn{appearance:none;border:1px solid #1f8f42;cursor:pointer;padding:11px 15px;font-weight:800;color:#07100b;background:linear-gradient(135deg,#16a34a,#86efac);box-shadow:none}
    .btn.alt{border-color:#0e7a58;background:linear-gradient(135deg,#064e3b,#10b981);color:#eaffef}
    .btn.warn{border-color:#8a6107;background:linear-gradient(135deg,var(--warn),#ffe7b0);color:#1f1604}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}

    /* Grid & cards â€” square corners */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:18px}
    .card{grid-column:span 12;background:var(--panel);border:1px solid var(--line);padding:20px;box-shadow:var(--shadow);transform:translateY(0);transition:transform .25s ease, box-shadow .25s ease;animation:cardIn .7s ease both}
    @media (min-width:980px){.span-6{grid-column:span 6}.span-7{grid-column:span 7}.span-5{grid-column:span 5}}

    /* Section heading */
    .hrow{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .chip{height:22px;padding:0 10px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;font-size:11px;letter-spacing:.3px;border:1px solid var(--line);background:rgba(34,197,94,.08);color:#dfffe9}

    h3{margin:0 0 6px;font-size:16px}
    label{display:block;color:var(--muted);font-weight:800;margin:10px 0 6px}

    /* Inputs â€” square */
    input{width:100%;padding:12px 13px;border:1px solid var(--line);background:#0a1c11;color:var(--ink)}
    input:focus{outline:none;border-color:#1f8f42;box-shadow:0 0 0 3px rgba(34,197,94,.18)}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .status{margin-top:10px;color:var(--muted);font-size:12px}
    .small{font-size:12px;color:var(--muted)}

    /* Output â€” square */
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1a10;padding:12px;border:1px dashed var(--line);margin:0}
    .result{padding:14px;border:1px dashed var(--line);text-align:center;font-weight:900;background:#0b1a10}

    footer{color:var(--muted);text-align:center;margin-top:18px}
  /* --- Centered title styles & animations --- */
    .topbar{display:flex;align-items:center;gap:12px}
    .titleWrap{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;margin-top:6px}
    .dollarTitle{font-family:'Cinzel', Georgia, serif;letter-spacing:.12em;font-weight:900;font-size:34px;line-height:1.1;margin:2px 0;background:linear-gradient(180deg,#eaffef 0%, #a7f3d0 40%, #34d399 70%, #065f46 100%);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 2px 0 rgba(0,0,0,.25)}
    .subtitle{color:var(--muted);font-weight:800;letter-spacing:.2em;text-transform:uppercase}
    @media (min-width:980px){ .dollarTitle{font-size:44px} }

    /* Cards entrance + hover */
    @keyframes cardIn{from{opacity:0;transform:translateY(14px) scale(.98)} to{opacity:1;transform:translateY(0) scale(1)}}
    .card:hover{transform:translateY(-2px)}
    .grid > .card:nth-of-type(1){animation-delay:.05s}
    .grid > .card:nth-of-type(2){animation-delay:.10s}
    .grid > .card:nth-of-type(3){animation-delay:.15s}
    .grid > .card:nth-of-type(4){animation-delay:.20s}
    .grid > .card:nth-of-type(5){animation-delay:.25s}
    .grid > .card:nth-of-type(6){animation-delay:.30s}

    /* Animated accent underline for h3 */
    h3{position:relative;padding-bottom:6px}
    h3:after{content:"";position:absolute;left:0;right:0;height:2px;bottom:-2px;background:linear-gradient(90deg,transparent,rgba(16,185,129,.8),transparent);transform:scaleX(0);transform-origin:left;animation:underline .9s .3s ease-out both}
    @keyframes underline{to{transform:scaleX(1)}}
  </style>
</head>
<body id="gradient">
  <main class="wrap">
    <header class="hero">
      <div class="topbar">
        <div id="netBadge" class="badge">Network: â€”</div>
        <div id="ctrBadge" class="badge">Contract: â€”</div>
        <div class="spacer"></div>
        <button id="connectBtn" class="btn">Connect Wallet</button>
      </div>
      <div class="titleWrap">
        <h1 class="dollarTitle">ANONYMOUS SALARY REVEAL</h1>
        <div class="subtitle">$ private by role &amp; region $</div>
      </div>
    </header>

    <section class="grid">
      <!-- Publish post -->
      <section class="card span-6">
        <div class="hrow"><span class="chip">PUBLISH</span><h3>Publish Salary Post (encrypted)</h3></div>
        <label>Salary (integer, minor units e.g. cents)</label>
        <input id="salaryVal" type="number" min="0" max="100000000" value="1200000"/>
        <div class="row">
          <div style="flex:1">
            <label>Role code (uint16)</label>
            <input id="roleVal" type="number" min="0" max="65535" value="101"/>
          </div>
          <div style="flex:1">
            <label>Region code (uint16)</label>
            <input id="regionVal" type="number" min="0" max="65535" value="840"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="publishBtn" class="btn">Encrypt & Publish</button>
          <button id="clearLogs" class="btn ghost">Clear Logs</button>
          <div id="pubStatus" class="small"></div>
        </div>
        <div class="status">New Post ID: <span id="newPostId">â€”</span></div>
        <div id="pubTx" class="status"></div>
      </section>

      <!-- Reveal if match -->
      <section class="card span-6">
        <div class="hrow"><span class="chip">REVEAL</span><h3>Reveal Salary If (role, region) Match</h3></div>
        <label>Post ID</label>
        <input id="revealPostId" type="number" min="0" value="0"/>
        <div class="row">
          <div style="flex:1">
            <label>Your role code (uint16)</label>
            <input id="myRole" type="number" min="0" max="65535" value="101"/>
          </div>
          <div style="flex:1">
            <label>Your region code (uint16)</label>
            <input id="myRegion" type="number" min="0" max="65535" value="840"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="revealBtn" class="btn alt">Encrypt & Request Reveal</button>
          <div id="revStatus" class="small"></div>
        </div>
        <div class="status">Reveal Handle: <span id="revealHandle">â€”</span></div>
        <div class="row" style="margin-top:10px">
          <button id="userDecBtn" class="btn">User decrypt (EIPâ€‘712)</button>
          <div id="decStatus" class="small"></div>
        </div>
        <div style="margin-top:8px"><label>Decrypted result (0 = no match)</label><div id="revealOut" class="result">â€”</div></div>
      </section>

      <!-- Owner tools -->
      <section class="card span-7">
        <div class="hrow"><span class="chip">OWNER</span><h3>Owner Utilities</h3></div>
        <label>Post ID</label>
        <input id="ownerPostId" type="number" min="0" value="0"/>
        <div class="row" style="margin-top:10px">
          <button id="makePublicBtn" class="btn warn">makeSalaryPublic()</button>
          <button id="getSalaryHandleBtn" class="btn">salaryHandle()</button>
          <div id="ownerStatus" class="small"></div>
        </div>
        <div style="margin-top:10px"><label>Salary handle</label><pre id="salaryHandleBox">â€”</pre></div>
        <div class="row" style="margin-top:10px">
          <button id="publicDecBtn" class="btn alt">Public decrypt</button>
          <div id="pubDecStatus" class="small"></div>
        </div>
        <div style="margin-top:8px"><label>Public salary (if made public)</label><div id="publicSalaryOut" class="result">â€”</div></div>
      </section>

      <!-- Logs -->
      <section class="card span-5">
        <div class="hrow"><span class="chip" style="background:rgba(34,197,94,.14)">LOGS</span><h3>Debug console</h3></div>
        <div class="row" style="margin-top:8px">
          <button id="copyLogs" class="btn alt">Copy</button>
          <label class="small" style="margin-left:auto;display:flex;align-items:center;gap:8px">
            <input id="debugVerbose" type="checkbox"/> Verbose
          </label>
        </div>
        <pre id="logBox" style="max-height:260px;overflow:auto">â€”</pre>
      </section>
    </section>

    <footer>Built with Zama FHEVM â€¢ Relayer SDK 0.2.0 â€¢ Ethers v6</footer>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
  <script>
  // Background tween (cosmetic) â€” green hues
  var colors=[[5,20,10],[10,40,22],[8,28,18],[12,30,15],[6,26,14],[14,24,14]];var step=0,colorIndices=[0,1,2,3],gradientSpeed=0.002;
  function updateGradient(){if ($===undefined) return;var c0_0=colors[colorIndices[0]],c0_1=colors[colorIndices[1]],c1_0=colors[colorIndices[2]],c1_1=colors[colorIndices[3]];var istep=1-step;var r1=Math.round(istep*c0_0[0]+step*c0_1[0]);var g1=Math.round(istep*c0_0[1]+step*c0_1[1]);var b1=Math.round(istep*c0_0[2]+step*c0_1[2]);var color1="rgb("+r1+","+g1+","+b1+")";var r2=Math.round(istep*c1_0[0]+step*c1_1[0]);var g2=Math.round(istep*c1_0[1]+step*c1_1[1]);var b2=Math.round(istep*c1_0[2]+step*c1_1[2]);var color2="rgb("+r2+","+g2+","+b2+")";$('#gradient').css({background:"-webkit-gradient(linear, left top, right top, from("+color1+"), to("+color2+"))"}).css({background:"-moz-linear-gradient(left, "+color1+" 0%, "+color2+" 100%)"});step+=gradientSpeed;if(step>=1){step%=1;colorIndices[0]=colorIndices[1];colorIndices[2]=colorIndices[3];colorIndices[1]=(colorIndices[1]+Math.floor(1+Math.random()*(colors.length-1)))%colors.length;colorIndices[3]=(colorIndices[3]+Math.floor(1+Math.random()*(colors.length-1)))%colors.length;}}setInterval(updateGradient,10);
  </script>

  <script type="module">
    import { BrowserProvider, Contract, Interface, getAddress } from "https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm";
    import { initSDK, createInstance, SepoliaConfig } from "https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js";

    // ===== CONFIG =====
    const CONFIG = {
      NETWORK_NAME: "Sepolia",
      CHAIN_ID_HEX: "0xaa36a7", // 11155111
      RELAYER_URL: "https://relayer.testnet.zama.org",
      GATEWAY_URL: "https://gateway.testnet.zama.org",
      CONTRACT_ADDRESS: "0x9846fd156864cbb84fe3Ca9aBE352BbEaBC2443A" // <-- PUT YOUR ADDRESS
    };

    // ===== ABI =====
    const ABI = [
      { "anonymous":false, "inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"owner","type":"address"}], "name":"PostPublished","type":"event" },
      { "anonymous":false, "inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"requester","type":"address"},{"indexed":false,"internalType":"bytes32","name":"revealHandle","type":"bytes32"}], "name":"SalaryRevealed","type":"event" },
      { "anonymous":false, "inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"}], "name":"SalaryMadePublic","type":"event" },

      { "inputs":[{"internalType":"bytes32","name":"encSalary","type":"bytes32"},{"internalType":"bytes32","name":"encRoleId","type":"bytes32"},{"internalType":"bytes32","name":"encRegionId","type":"bytes32"},{"internalType":"bytes","name":"attestation","type":"bytes"}],"name":"publish","outputs":[{"internalType":"uint256","name":"id","type":"uint256"}],"stateMutability":"nonpayable","type":"function" },
      { "inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"bytes32","name":"requesterRole","type":"bytes32"},{"internalType":"bytes32","name":"requesterRegion","type":"bytes32"},{"internalType":"bytes","name":"attestation","type":"bytes"}],"name":"revealIfMatch","outputs":[{"internalType":"bytes32","name":"handle","type":"bytes32"}],"stateMutability":"nonpayable","type":"function" },
      { "inputs":[{"internalType":"uint256","name":"id","type":"uint256"}],"name":"salaryHandle","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function" },
      { "inputs":[{"internalType":"uint256","name":"id","type":"uint256"}],"name":"makeSalaryPublic","outputs":[],"stateMutability":"nonpayable","type":"function" }
    ];

    const IFACE = new Interface(ABI);

    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    const toHex = u8 => '0x' + Array.from(u8, b => b.toString(16).padStart(2,'0')).join('');
    const short = a => a ? a.slice(0,6) + 'â€¦' + a.slice(-4) : 'â€”';
    const nowIso = () => new Date().toISOString().split('T')[1].replace('Z','');

    function j(v){ try { return typeof v==='string'? v : JSON.stringify(v,(k,val)=> (typeof val==='string'&&val.length>120)? val.slice(0,60)+'â€¦'+val.slice(-30): val,2);} catch { return String(v);} }
    function log(msg, obj){ const line = `[${nowIso()}] ${msg}`; console.log(line, obj??''); if(!logBox) return; if(logBox.textContent==='â€”') logBox.textContent=''; logBox.textContent += line + (obj? ('\n'+j(obj)) : '') + '\n'; logBox.scrollTop = logBox.scrollHeight; }
    function logError(ctx, e){ const err = { message: e?.reason||e?.shortMessage||e?.message||String(e), code: e?.code, data: e?.data, tx: e?.transaction }; log(`âŒ ${ctx}`, err); }

    // ===== UI refs =====
    const netBadge = $('#netBadge');
    const ctrBadge = $('#ctrBadge');
    const connectBtn = $('#connectBtn');

    const salaryVal = $('#salaryVal');
    const roleVal = $('#roleVal');
    const regionVal = $('#regionVal');
    const publishBtn = $('#publishBtn');
    const pubStatus = $('#pubStatus');
    const pubTx = $('#pubTx');
    const newPostIdEl = $('#newPostId');

    const revealPostId = $('#revealPostId');
    const myRole = $('#myRole');
    const myRegion = $('#myRegion');
    const revealBtn = $('#revealBtn');
    const revStatus = $('#revStatus');
    const revealHandleEl = $('#revealHandle');
    const userDecBtn = $('#userDecBtn');
    const decStatus = $('#decStatus');
    const revealOut = $('#revealOut');

    const ownerPostId = $('#ownerPostId');
    const makePublicBtn = $('#makePublicBtn');
    const getSalaryHandleBtn = $('#getSalaryHandleBtn');
    const ownerStatus = $('#ownerStatus');
    const salaryHandleBox = $('#salaryHandleBox');
    const publicDecBtn = $('#publicDecBtn');
    const pubDecStatus = $('#pubDecStatus');
    const publicSalaryOut = $('#publicSalaryOut');

    const logBox = document.getElementById('logBox');
    const copyBtn = document.getElementById('copyLogs');
    const clearBtn = document.getElementById('clearLogs');

    // ===== State =====
    let provider, signer, address, contract, relayer;
    netBadge.textContent = `Network: ${CONFIG.NETWORK_NAME}`;
    ctrBadge.textContent = `Contract: ${short(CONFIG.CONTRACT_ADDRESS)}`;

    // ===== Relayer init =====
    async function initRelayer(){
      if (relayer) return relayer;
      log('ðŸ”Œ initSDK() & createInstanceâ€¦', { relayerUrl: CONFIG.RELAYER_URL });
      await initSDK();
      relayer = await createInstance({
        ...SepoliaConfig,
        relayerUrl: CONFIG.RELAYER_URL,
        network: window.ethereum,
        debug: true,
      });
      log('âœ… Relayer ready');
      return relayer;
    }

    // ===== Wallet connect =====
    async function connect(){
      if(!window.ethereum) throw new Error('Install MetaMask / compatible wallet');
      provider = new BrowserProvider(window.ethereum);
      await provider.send('eth_requestAccounts', []);
      const net = await provider.getNetwork();
      log('ðŸ”— Wallet connected', { chainId: Number(net.chainId), hex: '0x'+Number(net.chainId).toString(16) });
      if (net.chainId !== 11155111n) {
        try { await provider.send('wallet_switchEthereumChain', [{ chainId: CONFIG.CHAIN_ID_HEX }]); log('ðŸ” Switched chain', { to: CONFIG.CHAIN_ID_HEX }); } catch(e){ logError('switch chain', e);} }
      signer = await provider.getSigner();
      address = await signer.getAddress();
      contract = new Contract(getAddress(CONFIG.CONTRACT_ADDRESS), ABI, signer);
      connectBtn.textContent = short(address);
      log('ðŸ“„ Contract attached', { contract: CONFIG.CONTRACT_ADDRESS, user: address });
      await initRelayer();
    }
    connectBtn.addEventListener('click', async ()=>{ try{ await connect(); } catch(e){ logError('connect', e); alert(e.message||e); } });

    // ===== Helpers for encryption =====
    function add16(enc, v){ if(enc.add16) enc.add16(BigInt(v)); else if (enc.addUint16) enc.addUint16(BigInt(v)); else throw new Error('SDK: add16 not found'); }
    function add32(enc, v){ if(enc.add32) enc.add32(BigInt(v)); else if (enc.addUint32) enc.addUint32(BigInt(v)); else throw new Error('SDK: add32 not found'); }

    // ===== Publish =====
    publishBtn.addEventListener('click', async ()=>{
      try{
        if(!contract) await connect();
        const salary = Math.max(0, Math.min(100_000_000, parseInt(salaryVal.value||'0')));
        const role = Math.max(0, Math.min(65535, parseInt(roleVal.value||'0')));
        const region = Math.max(0, Math.min(65535, parseInt(regionVal.value||'0')));
        pubStatus.textContent = 'Encryptingâ€¦';
        const r = await initRelayer();
        const enc = r.createEncryptedInput(getAddress(CONFIG.CONTRACT_ADDRESS), getAddress(address));
        add32(enc, salary); add16(enc, role); add16(enc, region);
        const { handles, inputProof } = await enc.encrypt();
        const [hSalary, hRole, hRegion] = handles.map(h=> (typeof h==='string'? h : toHex(h)));
        const att = typeof inputProof === 'string' ? (inputProof.startsWith('0x')? inputProof : ('0x'+inputProof)) : toHex(inputProof);
        log('ðŸ” Encrypted publish payload', { hSalary, hRole, hRegion, attLen: att.length });
        pubStatus.textContent = 'Sending txâ€¦';
        const tx = await contract.publish(hSalary, hRole, hRegion, att);
        pubTx.textContent = 'TX: ' + tx.hash;
        const rec = await tx.wait();
        // Parse PostPublished for new id
        let newId = null;
        for (const lg of rec.logs){ try { const p = IFACE.parseLog(lg); if (p?.name==='PostPublished'){ newId = p.args.id?.toString?.() || p.args[0]?.toString?.(); break; } } catch(e){} }
        if (!newId){ log('â„¹ï¸ PostPublished not found; check events or indexer', rec.logs); }
        newPostIdEl.textContent = newId ?? 'â€”';
        pubStatus.textContent = 'Done';
        log('âœ… publish confirmed', { newId });
      }catch(e){ console.error(e); logError('publish', e); pubStatus.textContent = 'Error: '+(e.reason||e.message||String(e)); }
    });

    // ===== Reveal If Match =====
    revealBtn.addEventListener('click', async ()=>{
      try{
        if(!contract) await connect();
        const id = BigInt(revealPostId.value || '0');
        const myR = Math.max(0, Math.min(65535, parseInt(myRole.value||'0')));
        const myG = Math.max(0, Math.min(65535, parseInt(myRegion.value||'0')));
        revStatus.textContent = 'Encryptingâ€¦';
        const r = await initRelayer();
        const enc = r.createEncryptedInput(getAddress(CONFIG.CONTRACT_ADDRESS), getAddress(address));
        add16(enc, myR); add16(enc, myG);
        const { handles, inputProof } = await enc.encrypt();
        const [hRole, hRegion] = handles.map(h=> (typeof h==='string'? h : toHex(h)));
        const att = typeof inputProof === 'string' ? (inputProof.startsWith('0x')? inputProof : ('0x'+inputProof)) : toHex(inputProof);
        log('ðŸ” Encrypted reveal payload', { hRole, hRegion, attLen: att.length });
        revStatus.textContent = 'Sending txâ€¦';
        const tx = await contract.revealIfMatch(id, hRole, hRegion, att);
        const rec = await tx.wait();
        let handle = null;
        for (const lg of rec.logs){ try { const p = IFACE.parseLog(lg); if (p?.name==='SalaryRevealed'){ handle = (p.args.revealHandle || p.args[2]); handle = typeof handle==='string' ? handle : '0x'+Buffer.from(handle).toString('hex'); break; } } catch(e){} }
        if(!handle) throw new Error('Reveal event not found');
        revealHandleEl.textContent = handle;
        revStatus.textContent = 'OK â€” handle captured';
        log('âœ… revealIfMatch confirmed', { handle });
      }catch(e){ console.error(e); logError('revealIfMatch', e); revStatus.textContent = 'Error: '+(e.reason||e.message||String(e)); }
    });

    // ===== User Decrypt (private) =====
    userDecBtn.addEventListener('click', async ()=>{
      try{
        const h = revealHandleEl.textContent.trim();
        if(!h || h==='â€”') throw new Error('No handle');
        decStatus.textContent = 'EIPâ€‘712â€¦';
        const r = await initRelayer();
        const kp = r.generateKeypair();
        const startTs = Math.floor(Date.now()/1000).toString();
        const days = '7';
        const eip = r.createEIP712(kp.publicKey, [getAddress(CONFIG.CONTRACT_ADDRESS)], startTs, days);
        const provider2 = new BrowserProvider(window.ethereum); const signer2 = await provider2.getSigner();
        const signature = await signer2.signTypedData(
          eip.domain,
          { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification },
          eip.message
        );
        decStatus.textContent = 'userDecryptâ€¦';
        const out = await r.userDecrypt(
          [{ handle: h, contractAddress: getAddress(CONFIG.CONTRACT_ADDRESS) }],
          kp.privateKey,
          kp.publicKey,
          signature.replace(/^0x/, ''),
          [getAddress(CONFIG.CONTRACT_ADDRESS)],
          await signer2.getAddress(),
          startTs,
          days
        );
        const raw = out[h] ?? out[Object.keys(out).find(k=>k.toLowerCase()===h.toLowerCase())];
        const val = Number(raw);
        revealOut.textContent = isFinite(val) ? String(val) : String(raw);
        decStatus.textContent = 'Done';
        log('ðŸ”Ž userDecrypt result', { raw, parsed: revealOut.textContent });
      }catch(e){ console.error(e); logError('userDecrypt', e); decStatus.textContent = 'Error: '+(e.reason||e.message||String(e)); }
    });

    // ===== Owner: make public & get salary handle =====
    makePublicBtn.addEventListener('click', async ()=>{
      try{
        if(!contract) await connect();
        const id = BigInt(ownerPostId.value||'0');
        ownerStatus.textContent = 'Submittingâ€¦';
        const tx = await contract.makeSalaryPublic(id);
        await tx.wait();
        ownerStatus.textContent = 'Salary is public';
        log('âœ… makeSalaryPublic done', { id: String(id) });
      }catch(e){ console.error(e); logError('makeSalaryPublic', e); ownerStatus.textContent = 'Error: '+(e.reason||e.message||String(e)); }
    });

    getSalaryHandleBtn.addEventListener('click', async ()=>{
      try{
        if(!contract) await connect();
        const id = BigInt(ownerPostId.value||'0');
        ownerStatus.textContent = 'Fetchingâ€¦';
        const h = await contract.salaryHandle(id);
        salaryHandleBox.textContent = String(h);
        ownerStatus.textContent = 'OK';
      }catch(e){ console.error(e); logError('salaryHandle', e); ownerStatus.textContent = 'Error: '+(e.reason||e.message||String(e)); }
    });

    publicDecBtn.addEventListener('click', async ()=>{
      try{
        const h = salaryHandleBox.textContent.trim();
        if(!h || h==='â€”') throw new Error('Get salary handle first');
        pubDecStatus.textContent = 'publicDecryptâ€¦';
        const r = await initRelayer();
        const out = await r.publicDecrypt([h]);
        const raw = out[h] ?? out[Object.keys(out).find(k=>k.toLowerCase()===h.toLowerCase())];
        const val = Number(raw);
        publicSalaryOut.textContent = isFinite(val) ? String(val) : String(raw);
        pubDecStatus.textContent = 'Done';
      }catch(e){ console.error(e); logError('publicDecrypt', e); pubDecStatus.textContent = 'Error: '+(e.reason||e.message||String(e)); }
    });

    // ===== Logs =====
    copyBtn?.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(logBox.textContent); log('ðŸ“‹ logs copied'); }catch(e){ logError('copy logs', e);} });
    clearBtn?.addEventListener('click', ()=>{ logBox.textContent=''; log('ðŸ§¹ logs cleared'); });
    window.addEventListener('unhandledrejection', (ev)=> logError('unhandledrejection', ev.reason));
  </script>
</body>
</html>
